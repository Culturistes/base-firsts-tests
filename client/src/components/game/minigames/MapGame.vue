<template>
  <div class="minigame mg-map">
    <QuizBlock
      >OÃ¹ se trouve la ville de
      {{ $store.state.livegame.minigame.title }} ?</QuizBlock
    >
    <div id="map"></div>
    <QuizBlock
      class="ui-question"
      v-if="$store.state.livegame.currentStep == steps.MINI_GAME_ROUND"
    >
      <label>
        <p>
          Bonus : Comment s'appellent les habitants de
          {{ $store.state.livegame.minigame.title }} ?
        </p>
        <TextInput color="black" v-model="gentile"
          >Entre le nom des habitans</TextInput
        >
      </label>
      <ArrowBtn @click="validateAnswer">Valider</ArrowBtn>
    </QuizBlock>
    <div
      class="ui-result"
      v-if="$store.state.livegame.currentStep == steps.MINI_GAME_ROUND_RESULT"
    >
      <p>
        Habitants: {{ $store.state.livegame.minigame.goodAnswer.gentileM }} et
        {{ $store.state.livegame.minigame.goodAnswer.gentileF }}
      </p>
      <ArrowBtn v-on:click="goNext">Suivant</ArrowBtn>
    </div>
  </div>
</template>

<script lang="ts">
import { Vue } from "vue-class-component";
import "leaflet/dist/leaflet.css";
import L from "leaflet";
import { Store } from "vuex/types";
import store from "@/store";
import StoreState from "@/interfaces/StoreState";
import { STEPS } from "@/views/Game.vue";

export default class MapGame extends Vue {
  myMap!: any;
  marker!: any;
  gentile = "";
  mapRange!: any;
  mapRangeRadius = 150;
  iconAnswer = L.icon({
    iconUrl: "/img/map/icon_answer.svg",
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -76],
  });
  iconTrue = L.icon({
    iconUrl: "/img/map/icon_true.svg",
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -76],
  });

  steps = STEPS;

  $store!: Store<StoreState>;

  hasBeenReset = false;

  initializeMap(): void {
    this.myMap = L.map("map").setView([46.23, 2.2], 6);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(this.myMap);

    this.marker = L.marker([0, 0], { icon: this.iconAnswer }).addTo(this.myMap);

    let jokerRadius = this.mapRangeRadius * 1000;
    let jokerLat = 46.23;
    let jokerLng = 2.2;
    this.mapRange = L.circle([jokerLat, jokerLng], {
      radius: jokerRadius,
      stroke: false,
      opacity: 0.8,
    });

    this.myMap.on("click", this.positionMarker);
  }

  validateAnswer(): void {
    console.log(this.$store.state.livegame.minigame);
    // distance in meter
    let distance = this.myMap.distance(
      this.marker.getLatLng(),
      this.$store.state.livegame.minigame.goodAnswer.latLng
    );

    // distance in km
    distance /= 1000;

    let datas = {
      dist: distance,
      gentile: this.gentile,
      latLng: [this.marker.getLatLng().lat, this.marker.getLatLng().lng],
    };

    console.log(this.marker.getLatLng());

    this.$store.commit("updateLiveGame", {
      index: "minigame",
      value: {
        ...this.$store.state.livegame.minigame,
        chosenAnswer: datas,
      },
    });

    this.$store.dispatch("readyForNext", {
      chosenAnswer: datas,
    });
  }

  mounted(): void {
    store.watch(
      () => this.$store.state.livegame.jokersParams.showMapRange,
      (showMapRange, oldVal) => {
        console.log("MapGame Watch:");
        if (showMapRange) {
          let newLat = this.$store.state.livegame.minigame.goodAnswer.latLng[0];
          let newLng = this.$store.state.livegame.minigame.goodAnswer.latLng[1];
          console.log(newLat, newLng);

          // Approximativement
          // Latitude: 1 deg = 110.574 km.
          // Longitude: 1 deg = 111.320*cos(latitude) km.

          // Make a gap with circle border to avoid approximation failure
          let showRadiusIn = this.mapRangeRadius - 20;

          let randomX = Math.random() * (showRadiusIn * 2) - showRadiusIn;
          let randomY = Math.random() * (showRadiusIn * 2) - showRadiusIn;

          newLng += (randomY / 111.32) * Math.cos(newLat);
          newLat += randomX / 110.574;

          this.mapRange.setLatLng([newLat, newLng]);
          this.mapRange.addTo(this.myMap);
        } else if (oldVal == true) {
          this.mapRange.remove();
        }
      }
    );

    this.initializeMap();
  }

  updated(): void {
    console.log("updated...");
    if (
      this.$store.state.livegame.currentStep ==
      this.steps.MINI_GAME_ROUND_RESULT
    ) {
      L.marker(this.$store.state.livegame.minigame.goodAnswer.latLng, {
        icon: this.iconTrue,
      }).addTo(this.myMap);

      this.$store.state.players.forEach((player: any) => {
        console.log(player);
        let marker = L.marker(player.chosenAnswer.latLng, {
          icon: this.iconAnswer,
          title: player.username,
        }).addTo(this.myMap);
        marker.bindTooltip(player.username).openTooltip();
      });

      this.myMap.off("click");
    } else if (
      this.$store.state.livegame.currentStep == this.steps.MINI_GAME_ROUND &&
      !this.hasBeenReset
    ) {
      this.myMap.eachLayer((layer: any) => {
        if (layer.options.title != undefined) {
          console.log(layer.options.title, "removed");
          layer.remove();
        }
      });

      this.mapRange.remove();

      this.hasBeenReset = true;
    }
  }

  positionMarker(ev: any): void {
    let lat = ev.latlng.lat;
    let lng = ev.latlng.lng;

    this.marker.setLatLng([lat, lng]);
  }

  goNext(): void {
    this.$store.dispatch("readyForNext");
    this.gentile = "";
    this.hasBeenReset = false;
  }
}
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">
#map {
  width: 100%;
  height: calc(100vh - 80px - 80px - 157px);

  margin: auto;
  margin-bottom: 40px;

  cursor: crosshair;
}

body.leaflet-dragging {
  #map {
    cursor: grabbing;
  }
}

.ui-question {
  position: absolute;
  width: 30%;
  bottom: 0;
  left: 0;
  margin: 0;
  padding: 20px;

  label {
    width: 100%;

    .input {
      width: 100%;
    }
  }

  .btn-arrow {
    margin: auto;
    margin-top: 50px;
  }
}
</style>
